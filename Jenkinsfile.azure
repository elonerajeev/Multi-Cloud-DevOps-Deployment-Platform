pipeline {
    agent any

    parameters {
        choice(
            name: 'CLOUD_PROVIDER',
            choices: ['azure', 'aws', 'both'],
            description: 'Select cloud provider for deployment'
        )
    }

    environment {
        AZURE_LOCATION = "eastus"
        AZURE_RESOURCE_GROUP = "shop-app-prod-rg"
        ACR_NAME = "shopappacr12345"
        ACR_LOGIN_SERVER = "${ACR_NAME}.azurecr.io"
        DOCKER_FRONTEND_IMAGE = "shop-app-frontend"
        DOCKER_BACKEND_IMAGE = "shop-app-backend"
        DOCKER_TAG = "azure-${BUILD_NUMBER}"
        AKS_CLUSTER_NAME = "shop-aks-prod"
        K8S_NAMESPACE = "shop"
    }

    triggers {
        githubPush()
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/elonerajeev/Multi-Cloud-DevOps-Deployment-Platform.git'
            }
        }

        stage('Build Images') {
            parallel {
                stage('Frontend Build') {
                    steps {
                        dir('app/frontend') {
                            sh '''
                            docker build -t $DOCKER_FRONTEND_IMAGE:$DOCKER_TAG -f Dockerfile.prod .
                            '''
                        }
                    }
                }

                stage('Backend Build') {
                    steps {
                        dir('app/backend') {
                            sh '''
                            docker build -t $DOCKER_BACKEND_IMAGE:$DOCKER_TAG -f Dockerfile.prod .
                            '''
                        }
                    }
                }
            }
        }

        stage('Security Scan (Trivy)') {
            steps {
                sh '''
                trivy image --exit-code 0 --severity HIGH,CRITICAL $DOCKER_BACKEND_IMAGE:$DOCKER_TAG || true
                trivy image --exit-code 0 --severity HIGH,CRITICAL $DOCKER_FRONTEND_IMAGE:$DOCKER_TAG || true
                '''
            }
        }

        stage('Push to Azure ACR') {
            steps {
                withCredentials([azureServicePrincipal('azure-credentials')]) {
                    sh '''
                    # Login to Azure
                    az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
                    
                    # Login to ACR
                    az acr login --name $ACR_NAME
                    
                    # Tag images for ACR
                    docker tag $DOCKER_BACKEND_IMAGE:$DOCKER_TAG $ACR_LOGIN_SERVER/$DOCKER_BACKEND_IMAGE:$DOCKER_TAG
                    docker tag $DOCKER_FRONTEND_IMAGE:$DOCKER_TAG $ACR_LOGIN_SERVER/$DOCKER_FRONTEND_IMAGE:$DOCKER_TAG
                    docker tag $DOCKER_BACKEND_IMAGE:$DOCKER_TAG $ACR_LOGIN_SERVER/$DOCKER_BACKEND_IMAGE:latest
                    docker tag $DOCKER_FRONTEND_IMAGE:$DOCKER_TAG $ACR_LOGIN_SERVER/$DOCKER_FRONTEND_IMAGE:latest
                    
                    # Push images to ACR
                    docker push $ACR_LOGIN_SERVER/$DOCKER_BACKEND_IMAGE:$DOCKER_TAG
                    docker push $ACR_LOGIN_SERVER/$DOCKER_FRONTEND_IMAGE:$DOCKER_TAG
                    docker push $ACR_LOGIN_SERVER/$DOCKER_BACKEND_IMAGE:latest
                    docker push $ACR_LOGIN_SERVER/$DOCKER_FRONTEND_IMAGE:latest
                    
                    echo "âœ… Images pushed to Azure ACR"
                    '''
                }
            }
        }

        stage('Deploy to AKS') {
            steps {
                withCredentials([azureServicePrincipal('azure-credentials')]) {
                    sh '''
                    # Get AKS credentials
                    az aks get-credentials --resource-group $AZURE_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --overwrite-existing
                    
                    # Update image tags in deployments
                    sed -i "s|image: .*$DOCKER_FRONTEND_IMAGE:.*|image: $ACR_LOGIN_SERVER/$DOCKER_FRONTEND_IMAGE:$DOCKER_TAG|g" k8s/frontend/deployment.yaml
                    sed -i "s|image: .*$DOCKER_BACKEND_IMAGE:.*|image: $ACR_LOGIN_SERVER/$DOCKER_BACKEND_IMAGE:$DOCKER_TAG|g" k8s/backend/deployment.yaml
                    
                    # Apply Kubernetes manifests
                    kubectl apply -f k8s/namespace.yaml
                    kubectl apply -f k8s/configmap.yaml
                    kubectl apply -f k8s/secret.yaml
                    kubectl apply -f k8s/backend/
                    kubectl apply -f k8s/frontend/
                    kubectl apply -f k8s/ingress.yaml
                    
                    # Wait for rollout
                    kubectl rollout status deployment/backend -n $K8S_NAMESPACE --timeout=5m
                    kubectl rollout status deployment/frontend -n $K8S_NAMESPACE --timeout=5m
                    
                    echo "âœ… Deployed to AKS"
                    '''
                }
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                echo "Waiting for services to be ready..."
                sleep 30
                kubectl get pods -n $K8S_NAMESPACE
                kubectl get svc -n $K8S_NAMESPACE
                '''
            }
        }

        stage('Get Application URLs') {
            steps {
                script {
                    sh '''
                    echo "================================================"
                    echo "ğŸŒ AZURE APPLICATION URLS"
                    echo "================================================"
                    
                    # Get Frontend URL
                    FRONTEND_URL=$(kubectl get svc frontend -n $K8S_NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "Pending...")
                    echo "Frontend: http://$FRONTEND_URL"
                    
                    # Get Backend URL
                    BACKEND_URL=$(kubectl get svc backend -n $K8S_NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "Pending...")
                    echo "Backend API: http://$BACKEND_URL:5000"
                    
                    echo "================================================"
                    '''
                }
            }
        }

        stage('Verify Monitoring') {
            steps {
                sh '''
                echo "================================================"
                echo "ğŸ“Š MONITORING STATUS"
                echo "================================================"
                
                # Check Prometheus
                PROM_STATUS=$(kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Not Found")
                echo "Prometheus: $PROM_STATUS"
                
                # Check Grafana
                GRAFANA_STATUS=$(kubectl get pods -n monitoring -l app.kubernetes.io/name=grafana -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Not Found")
                echo "Grafana: $GRAFANA_STATUS"
                
                # Get Grafana URL
                GRAFANA_URL=$(kubectl get svc -n monitoring monitoring-grafana -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "Pending...")
                echo "Grafana Dashboard: http://$GRAFANA_URL"
                echo "Default Login: admin / admin123"
                
                echo "================================================"
                '''
            }
        }
    }

    post {
        success {
            script {
                sh '''
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘   âœ… AZURE DEPLOYMENT SUCCESSFUL!              â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ğŸŒ Access your application on Azure:"
                echo "   Frontend: http://$(kubectl get svc frontend -n $K8S_NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
                echo "   Backend:  http://$(kubectl get svc backend -n $K8S_NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}'):5000"
                echo ""
                echo "ğŸ“Š Monitoring Dashboard:"
                echo "   Grafana: http://$(kubectl get svc -n monitoring monitoring-grafana -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
                echo ""
                echo "â° Build #${BUILD_NUMBER} completed at $(date)"
                echo "================================================"
                '''
            }
        }
        failure {
            echo "âŒ Azure Pipeline Failed!"
            sh 'kubectl get events -n $K8S_NAMESPACE --sort-by=.lastTimestamp | tail -20'
        }
        always {
            sh 'docker system prune -f'
        }
    }
}
